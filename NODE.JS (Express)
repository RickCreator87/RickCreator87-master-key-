import express from "express";
import crypto from "crypto";

const app = express();
app.use(express.json({ verify: rawBodySaver }));

function rawBodySaver(req, res, buf) {
  req.rawBody = buf;
}

function verifySignature(secret, payload, signature) {
  const hmac = crypto.createHmac("sha256", secret);
  const digest = "sha256=" + hmac.update(payload).digest("hex");
  return crypto.timingSafeEqual(Buffer.from(digest), Buffer.from(signature));
}

app.post("/github/webhook", (req, res) => {
  const signature = req.headers["x-hub-signature-256"];
  const event = req.headers["x-github-event"];
  const secret = process.env.GITHUBWEBHOOKSECRET;

  if (!verifySignature(secret, req.rawBody, signature)) {
    return res.status(401).send("Invalid signature");
  }

  switch (event) {
    case "pull_request":
      return res.send("PR logic");
    case "push":
      return res.send("Push logic");
    default:
      return res.send("OK");
  }
});

app.listen(3000);
